<filter name='${filter_name}' chain='root'>
  <!-- Accept return traffic for established connections -->
  <rule action='accept' direction='in' priority='10'>
    <all state='ESTABLISHED,RELATED'/>
  </rule>
% for idx, rule in enumerate(rules):
%   if rule.get('action') == 'accept' and rule.get('ip') and rule.get('port'):
  <!-- Accept ${rule['ip']}:${rule['port']} -->
  <rule action='accept' direction='out' priority='${50 + idx}'>
    <ip protocol='tcp' dstipaddr='${rule['ip']}' dstportstart='${rule['port']}' dstportend='${rule['port']}'/>
  </rule>
%   elif rule.get('action') == 'accept' and rule.get('ip'):
  <!-- Accept ${rule['ip']} -->
  <rule action='accept' direction='out' priority='${100 + idx}'>
    <ip dstipaddr='${rule['ip']}'/>
  </rule>
%   elif rule.get('action') == 'drop' and rule.get('subnet'):
<%
    subnet_parts = rule['subnet'].split('/')
    subnet_ip = subnet_parts[0]
    cidr = int(subnet_parts[1]) if len(subnet_parts) > 1 else 24
    # Convert CIDR to netmask (e.g., 24 -> 255.255.255.0)
    mask_int = (0xffffffff >> (32 - cidr)) << (32 - cidr)
    subnet_mask = '.'.join([str((mask_int >> (24 - i * 8)) & 0xff) for i in range(4)])
%>\
  <!-- Drop ${rule['subnet']} -->
  <rule action='drop' direction='out' priority='${100 + idx}'>
    <ip dstipaddr='${subnet_ip}' dstipmask='${subnet_mask}'/>
  </rule>
%   elif rule.get('action') == 'accept' and rule.get('all'):
  <!-- Accept all -->
  <rule action='accept' direction='out' priority='${100 + idx}'>
    <all/>
  </rule>
%   endif
% endfor
</filter>
